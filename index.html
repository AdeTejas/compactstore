<script>
  // Mock API fetch simulation
  async function fetchProducts() {
    console.log("Fetching products...");
    const response = await fetch('products.json');
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();
    return data.products; // Extract the products array
  }

  let products = [];
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
  let currentProduct = null;
  let carouselIndex = 0;

  async function loadProducts() {
    const spinner = document.getElementById('spinner');
    spinner.style.display = 'block';
    try {
      products = await fetchProducts();
      spinner.style.display = 'none';
      renderCarousel();
      filterAndSortProducts();
    } catch (error) {
      console.error("Fetch failed:", error);
      spinner.style.display = 'none';
      document.getElementById('product-grid').innerHTML = '<p>Error loading products. Check console.</p>';
    }
  }

  function renderCarousel() {
    const track = document.getElementById('carousel-track');
    const featuredProducts = products.filter(p => p.featured);
    track.innerHTML = featuredProducts.map(product => `
      <div class="carousel-item">
        <img src="${product.image}" alt="${product.name}" loading="lazy">
        <h3>${product.name}</h3>
        <p>$${product.price.toFixed(2)}</p>
      </div>
    `).join('');
    updateCarousel();
  }

  function updateCarousel() {
    const track = document.getElementById('carousel-track');
    const items = document.querySelectorAll('.carousel-item');
    track.style.transform = `translateX(-${carouselIndex * 33.33}%)`;
    setTimeout(() => {
      carouselIndex = (carouselIndex + 1) % Math.ceil(products.length / 3);
      updateCarousel();
    }, 5000);
  }

  function carouselPrev() {
    carouselIndex = (carouselIndex - 1 + Math.ceil(products.length / 3)) % Math.ceil(products.length / 3);
    updateCarousel();
  }

  function carouselNext() {
    carouselIndex = (carouselIndex + 1) % Math.ceil(products.length / 3);
    updateCarousel();
  }

  function filterAndSortProducts() {
    const maxPrice = document.getElementById('price-filter').value;
    const searchQuery = document.getElementById('search-input').value.toLowerCase();
    const category = document.getElementById('category-filter').value;
    const sortOption = document.getElementById('sort-option').value;
    const spinner = document.getElementById('spinner');
    spinner.style.display = 'block';

    setTimeout(() => {
      let filteredProducts = products.filter(p => 
        p.price <= maxPrice && 
        p.name.toLowerCase().includes(searchQuery) &&
        (category === 'all' || p.category === category)
      );

      if (sortOption === 'price-asc') {
        filteredProducts.sort((a, b) => a.price - b.price);
      } else if (sortOption === 'price-desc') {
        filteredProducts.sort((a, b) => b.price - a.price);
      } else if (sortOption === 'name-asc') {
        filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
      }

      const grid = document.getElementById('product-grid');
      grid.innerHTML = filteredProducts.length === 0 ? '<p>No products found.</p>' : filteredProducts.map(product => `
        <div class="product-card">
          <img src="${product.image}" alt="${product.name}" loading="lazy">
          <h3>${product.name}</h3>
          <p>$${product.price.toFixed(2)}</p>
          <p class="product-desc">${product.description || 'No description'}</p>
          <p>${'★'.repeat(product.rating)}${'☆'.repeat(5 - product.rating)}</p>
          <button onclick="addToCart(${product.id})" aria-label="Add ${product.name} to cart">Add to Cart</button>
          <button onclick="openQuickView(${product.id})" aria-label="Quick view ${product.name}">Quick View</button>
          <button class="wishlist-btn" onclick="toggleWishlistItem(${product.id})" aria-label="${wishlist.some(w => w.id === product.id) ? 'Remove' : 'Add'} ${product.name} to wishlist">${wishlist.some(w => w.id === product.id) ? '♥' : '♡'}</button>
        </div>
      `).join('');
      spinner.style.display = 'none';
    }, 300);
  }

  function filterProducts() {
    document.getElementById('price-value').textContent = document.getElementById('price-filter').value;
    filterAndSortProducts();
  }

  function addToCart(id) {
    const product = products.find(p => p.id === id);
    const cartItem = cart.find(item => item.id === id);
    if (cartItem) {
      cartItem.quantity += 1;
    } else {
      cart.push({ ...product, quantity: 1 });
    }
    updateCart();
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  function addToCartFromModal() {
    if (currentProduct) addToCart(currentProduct.id);
    closeModal();
  }

  function removeFromCart(id) {
    const cartItem = cart.find(item => item.id === id);
    if (cartItem.quantity > 1) {
      cartItem.quantity -= 1;
    } else {
      cart = cart.filter(item => item.id !== id);
    }
    updateCart();
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  function toggleWishlistItem(id) {
    const product = products.find(p => p.id === id);
    const inWishlist = wishlist.some(w => w.id === id);
    if (inWishlist) {
      wishlist = wishlist.filter(w => w.id !== id);
    } else {
      wishlist.push({ ...product, quantity: 1 });
    }
    updateWishlist();
    localStorage.setItem('wishlist', JSON.stringify(wishlist));
    filterAndSortProducts();
  }

  function updateCart() {
    const cartItems = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');
    const cartCount = document.getElementById('cart-count');
    cartItems.innerHTML = cart.length === 0 ? '<p>Your cart is empty.</p>' : cart.map(item => `
      <div class="cart-item">
        <span>${item.name} (x${item.quantity})</span>
        <div>
          <span>$${(item.price * item.quantity).toFixed(2)}</span>
          <button onclick="removeFromCart(${item.id})" aria-label="Remove ${item.name} from cart">Remove</button>
        </div>
      </div>
    `).join('');
    const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    cartTotal.textContent = `Total: $${total.toFixed(2)}`;
    cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
  }

  function updateWishlist() {
    const wishlistItems = document.getElementById('wishlist-items');
    const wishlistCount = document.getElementById('wishlist-count');
    wishlistItems.innerHTML = wishlist.length === 0 ? '<p>Your wishlist is empty.</p>' : wishlist.map(item => `
      <div class="cart-item">
        <span>${item.name}</span>
        <div>
          <span>$${item.price.toFixed(2)}</span>
          <button onclick="toggleWishlistItem(${item.id})" aria-label="Remove ${item.name} from wishlist">Remove</button>
        </div>
      </div>
    `).join('');
    wishlistCount.textContent = wishlist.length;
  }

  function toggleCart() {
    document.getElementById('cart-sidebar').classList.toggle('open');
    document.getElementById('wishlist-sidebar').classList.remove('open');
  }

  function toggleWishlist() {
    document.getElementById('wishlist-sidebar').classList.toggle('open');
    document.getElementById('cart-sidebar').classList.remove('open');
  }

  function toggleMenu() {
    document.getElementById('nav-controls').classList.toggle('open');
  }

  function toggleTheme() {
    document.body.classList.toggle('dark');
    const themeToggle = document.querySelector('.theme-toggle');
    themeToggle.textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
    localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
  }

  function openQuickView(id) {
    currentProduct = products.find(p => p.id === id);
    document.getElementById('modal-image').src = currentProduct.image;
    document.getElementById('modal-name').textContent = currentProduct.name;
    document.getElementById('modal-price').textContent = `$${currentProduct.price.toFixed(2)}`;
    document.getElementById('modal-rating').innerHTML = '★'.repeat(currentProduct.rating) + '☆'.repeat(5 - currentProduct.rating);
    document.getElementById('modal-size').textContent = currentProduct.size ? currentProduct.size.join(', ') : 'N/A';
    document.getElementById('modal-color').textContent = currentProduct.color ? currentProduct.color.join(', ') : 'N/A';
    document.getElementById('quick-view-modal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('quick-view-modal').style.display = 'none';
    currentProduct = null;
  }

  function checkout() {
    if (cart.length === 0) return alert('Cart is empty!');
    particleEffect();
    alert('Checkout complete! Thanks for shopping, Ade!');
    cart = [];
    updateCart();
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  function particleEffect() {
    const canvas = document.createElement('canvas');
    canvas.style.position = 'fixed';
    canvas.style.top = '0';
    canvas.style.left = '0';
    canvas.style.width = '100%';
    canvas.style.height = '100%';
    canvas.style.pointerEvents = 'none';
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const particles = [];
    for (let i = 0; i < 50; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 3 + 1,
        speedX: Math.random() * 4 - 2,
        speedY: Math.random() * 4 - 2,
        color: '#c0c0c0',
      });
    }
    let frame = 0;
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => {
        p.x += p.speedX;
        p.y += p.speedY;
        p.size *= 0.95;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
      });
      frame++;
      if (frame < 40) requestAnimationFrame(animate);
      else document.body.removeChild(canvas);
    }
    animate();
  }

  // Initialize theme
  if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark');
    document.querySelector('.theme-toggle').textContent = '☀️';
  }

  // Event listeners
  document.getElementById('search-input').addEventListener('input', filterAndSortProducts);
  document.getElementById('price-filter').addEventListener('input', filterProducts);
  document.getElementById('category-filter').addEventListener('change', filterAndSortProducts);
  document.getElementById('sort-option').addEventListener('change', filterAndSortProducts);

  // Initialize
  updateCart();
  updateWishlist();
  loadProducts();
</script>
